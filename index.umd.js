!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("@coral-xyz/anchor"),require("@solana/web3.js"),require("@solana/spl-token"),require("dotenv")):"function"==typeof define&&define.amd?define(["exports","@coral-xyz/anchor","@solana/web3.js","@solana/spl-token","dotenv"],n):n((e||self).aisaSolanaSdk={},e.anchor,e.web3_js,e.splToken,e.dotenv)}(this,function(e,n,r,t,o){function i(e){if(e&&e.__esModule)return e;var n=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var t=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(n,r,t.get?t:{enumerable:!0,get:function(){return e[r]}})}}),n.default=e,n}var c=/*#__PURE__*/i(n),s=/*#__PURE__*/i(o);function a(e,n){e.prototype=Object.create(n.prototype),e.prototype.constructor=e,u(e,n)}function u(e,n){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,n){return e.__proto__=n,e},u(e,n)}var l=new c.web3.PublicKey("G34e7zJuRne2pfDHh9YayixM2rJFdwV624NUzbj9FRR5");function m(e){return r.PublicKey.findProgramAddressSync([Buffer.from("main_account"),Buffer.from(e)],l)[0]}function f(e,n){return r.PublicKey.findProgramAddressSync([Buffer.from("sub_account"),e.toBuffer(),n.toBuffer()],l)[0]}var h=/*#__PURE__*/function(){function e(){this.program=void 0,this.provider=void 0,this.connection=void 0,this.signer=void 0,this.wallet=void 0}e.initialize=function(){try{var n=new e;return s.config(),n.wallet=n.loadWallet(),n.signer=n.wallet.payer,n.provider=new c.AnchorProvider(n.loadRpc(),n.wallet,{preflightCommitment:"processed"}),n.connection=n.provider.connection,n.program=n.getProgram("./utils/aisa_contracts.json",n.provider),Promise.resolve(n)}catch(e){return Promise.reject(e)}};var n=e.prototype;return n.getProgram=function(e,n){var r=JSON.parse(JSON.stringify(require(e)));return new c.Program(r,n)},n.loadRpc=function(){var e=process.env.RPC_URL;if(!e)throw new Error("RPC URL not defined in .env");try{return new c.web3.Connection(e,{commitment:"processed"})}catch(e){throw new Error("Failed to create RPC connection: "+e.message)}},n.loadWallet=function(){var e=process.env.PRIVATE_KEY;if(!e)throw new Error("PRIVATE_KEY not defined in .env");try{var n=Uint8Array.from(JSON.parse(e));if(64!==n.length)throw new Error("Invalid private key length");var t=r.Keypair.fromSecretKey(n);return new c.Wallet(t)}catch(e){throw new Error("Invalid private key format : "+e.message)}},n.sendAndConfirmTransaction=function(e,n,t,o){try{var i=this;return Promise.resolve(function(c,s){try{var a=Promise.resolve(i.connection.getLatestBlockhash()).then(function(c){var s=new r.TransactionMessage({payerKey:n,recentBlockhash:c.blockhash,instructions:e}).compileToV0Message(o),a=new r.VersionedTransaction(s);return a.sign(t),Promise.resolve(i.connection.sendTransaction(a)).then(function(e){return Promise.resolve(i.connection.confirmTransaction({blockhash:c.blockhash,lastValidBlockHeight:c.lastValidBlockHeight,signature:e},"confirmed")).then(function(){return e})})})}catch(e){return s(e)}return a&&a.then?a.then(void 0,s):a}(0,function(e){console.log(e)}))}catch(e){return Promise.reject(e)}},e}(),p=/*#__PURE__*/function(e){function n(){return e.apply(this,arguments)||this}a(n,e),n.initialize=function(){try{return Promise.resolve(e.initialize.call(this))}catch(e){return Promise.reject(e)}};var r=n.prototype;return r.createMainAccount=function(e,n){try{var r=this,t=[];return Promise.resolve(r.program.methods.createMainAccount(e,n).accounts({owner:r.signer.publicKey}).instruction()).then(function(e){return t.push(e),Promise.resolve(r.sendAndConfirmTransaction(t,r.signer.publicKey,[r.signer]))})}catch(e){return Promise.reject(e)}},r.getMainAccountState=function(e){try{return Promise.resolve(this.program.account.mainAccount.fetch(m(Uint8Array.from(e)))).then(function(e){return[e.owner,e.globalWhitelistedPayees]})}catch(e){return Promise.reject(e)}},r.getSubAccountState=function(e,n){try{var r=m(Uint8Array.from(e));return Promise.resolve(this.program.account.subAccount.fetch(f(r,n))).then(function(e){return[e.whitelistedPayees,e.whitelistedTokens,e.paymentInterval,e.paymentCount,e.maxPerPayment,e.lastPaymentTimestamp]})}catch(e){return Promise.reject(e)}},r.updateMainAccountRules=function(e,n){try{var r=this,t=[],o=m(Uint8Array.from(e));return Promise.resolve(r.program.methods.updateGlobalWhitelistedPayees(n).accounts({owner:r.signer.publicKey,mainAccount:o}).instruction()).then(function(e){return t.push(e),Promise.resolve(r.sendAndConfirmTransaction(t,r.signer.publicKey,[r.signer]))})}catch(e){return Promise.reject(e)}},r.updateSubAccountRules=function(e,n,r,t,o,i,c){try{var s=function(){function e(){function e(){return function(){if(i)return Promise.resolve(a.program.methods.updatePaymentCount(i).accounts({owner:a.signer.publicKey,agent:n,mainAccount:l}).instruction()).then(function(e){function r(){return Promise.resolve(a.sendAndConfirmTransaction(u,a.signer.publicKey,[a.signer]))}u.push(e);var t=function(){if(c)return Promise.resolve(a.program.methods.updatePaymentInterval(c).accounts({owner:a.signer.publicKey,agent:n,mainAccount:l}).instruction()).then(function(e){u.push(e)})}();return t&&t.then?t.then(r):r()})}()}var r=function(){if(o)return Promise.resolve(a.program.methods.updateMaxPerPayment(o).accounts({owner:a.signer.publicKey,agent:n,mainAccount:l}).instruction()).then(function(e){u.push(e)})}();return r&&r.then?r.then(e):e()}var r=function(){if(t)return Promise.resolve(a.program.methods.updateWhitelistedTokens(t).accounts({owner:a.signer.publicKey,agent:n,mainAccount:l}).instruction()).then(function(e){u.push(e)})}();return r&&r.then?r.then(e):e()},a=this,u=[],l=m(Uint8Array.from(e)),f=function(){if(r)return Promise.resolve(a.program.methods.updateWhitelistedPayees(r).accounts({owner:a.signer.publicKey,agent:n,mainAccount:l}).instruction()).then(function(e){u.push(e)})}();return Promise.resolve(f&&f.then?f.then(s):s())}catch(e){return Promise.reject(e)}},r.increaseAllowance=function(e,n,r,o,i,c,s){try{var a=this,u=[],l=m(Uint8Array.from(e)),f=s||t.TOKEN_PROGRAM_ID;return Promise.resolve(a.program.methods.increaseSubAccountAllowance(r,o).accounts({owner:a.signer.publicKey,ownerTokenAccount:c||t.getAssociatedTokenAddressSync(i,a.signer.publicKey,!1,f,t.ASSOCIATED_TOKEN_PROGRAM_ID),agent:n,mainAccount:l,tokenMint:i,tokenProgram:f}).instruction()).then(function(e){return u.push(e),Promise.resolve(a.sendAndConfirmTransaction(u,a.signer.publicKey,[a.signer]))})}catch(e){return Promise.reject(e)}},r.decreaseAllowance=function(e,n,r,o,i,c,s){try{var a=this,u=[],l=m(Uint8Array.from(e)),h=f(l,a.signer.publicKey),p=s||t.TOKEN_PROGRAM_ID;return Promise.resolve(a.program.methods.decreaseSubAccountAllowance(r,o).accounts({owner:a.signer.publicKey,ownerTokenAccount:c||t.getAssociatedTokenAddressSync(i,a.signer.publicKey,!1,p,t.ASSOCIATED_TOKEN_PROGRAM_ID),saTokenAccount:t.getAssociatedTokenAddressSync(i,h,!0,p,t.ASSOCIATED_TOKEN_PROGRAM_ID),agent:n,mainAccount:l,tokenMint:i,tokenProgram:p}).instruction()).then(function(e){return u.push(e),Promise.resolve(a.sendAndConfirmTransaction(u,a.signer.publicKey,[a.signer]))})}catch(e){return Promise.reject(e)}},r.createSubAccount=function(e,n,r,o,i,s,a,u,l,f,h){try{var p=this,d=[],y=m(Uint8Array.from(e)),g=h||t.TOKEN_PROGRAM_ID;return Promise.resolve(p.program.methods.createSubAccount(r,o,i,s,a).accounts({owner:p.signer.publicKey,agent:n,mainAccount:y}).instruction()).then(function(e){function r(e){return Promise.resolve(p.sendAndConfirmTransaction(d,p.signer.publicKey,[p.signer]))}d.push(e);var o=function(){if(u.gt(new c.BN(0))){if(!l)throw new Error("tokenMint must be specified if allowanceAmount is greater than 0");return Promise.resolve(p.program.methods.increaseSubAccountAllowance(u,0).accounts({owner:p.signer.publicKey,ownerTokenAccount:f||t.getAssociatedTokenAddressSync(l,p.signer.publicKey,!1,g,t.ASSOCIATED_TOKEN_PROGRAM_ID),agent:n,mainAccount:y,tokenMint:l,tokenProgram:g}).instruction()).then(function(e){d.push(e)})}}();return o&&o.then?o.then(r):r()})}catch(e){return Promise.reject(e)}},n}(h),d=/*#__PURE__*/function(e){function n(){return e.apply(this,arguments)||this}a(n,e),n.initialize=function(){try{return Promise.resolve(e.initialize.call(this))}catch(e){return Promise.reject(e)}};var r=n.prototype;return r.getMainAccountState=function(e){try{return Promise.resolve(this.program.account.mainAccount.fetch(m(Uint8Array.from(e)))).then(function(e){return[e.owner,e.globalWhitelistedPayees]})}catch(e){return Promise.reject(e)}},r.getSubAccountState=function(e){try{var n=m(Uint8Array.from(e));return Promise.resolve(this.program.account.subAccount.fetch(f(n,this.signer.publicKey))).then(function(e){return[e.whitelistedPayees,e.whitelistedTokens,e.paymentInterval,e.paymentCount,e.maxPerPayment,e.lastPaymentTimestamp]})}catch(e){return Promise.reject(e)}},r.paymentRequest=function(e,n,r,o,i,c){try{var s=this,a=[],u=m(Uint8Array.from(e)),l=f(u,s.signer.publicKey),h=c||t.TOKEN_PROGRAM_ID;return Promise.resolve(s.program.methods.paymentRequest(r).accounts({agent:s.signer.publicKey,payee:n,mainAccount:u,saTokenAccount:t.getAssociatedTokenAddressSync(o,l,!0,h,t.ASSOCIATED_TOKEN_PROGRAM_ID),payeeTokenAccount:i||t.getAssociatedTokenAddressSync(o,n,!1,h,t.ASSOCIATED_TOKEN_PROGRAM_ID),tokenMint:o,tokenProgram:h}).instruction()).then(function(e){return a.push(e),Promise.resolve(s.sendAndConfirmTransaction(a,s.signer.publicKey,[s.signer]))})}catch(e){return Promise.reject(e)}},n}(h);e.MainAccountTxHandler=p,e.SubAccountTxHandler=d});
